<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Coleta de Validade</title>

  <script src="https://unpkg.com/html5-qrcode"></script>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const loja = urlParams.get("loja");

    const scriptUrls = {
      boituva: "https://script.google.com/macros/s/AKfycbxMHxz2DzR6kXDnxAxeTVTR66guR0hWUEQzOd7co9805R5Rv8faabAucLj2tlW1K1bAAQ/exec",
      salto: "https://script.google.com/macros/s/AKfycbxPzATdhAen8cK_VAso7RsqeAX5Q1uLuByCD6UrrvVqWtgLtL43XWQ2aIQq2aBqlW7O/exec",
      teste: "https://script.google.com/macros/s/AKfycbzDr1hY6gA8xSXcyH-Q6-z_H3CRh3YNotrDsyPEV94kTEhb1jNAdn4OgMqQjbt0BA1i/exec"
    };

    const scriptUrl = scriptUrls[loja];

    if (!scriptUrl) {
      alert("Loja inválida ou não informada na URL.");
      throw new Error("Loja inválida.");
    }

    const usuarioLogado = sessionStorage.getItem("usuarioLogado");
    if (!usuarioLogado) {
      window.location.href = `https://osalomaoleme.github.io/vencimentodeposito/login.html${loja ? '?loja=' + loja : ''}`;
    }

    document.title = `Coleta de Validade - ${loja.toUpperCase()}`;
  </script>

  <style>
    /* Seu CSS aqui... (mantém igual ao atual) */
  </style>
</head>

<body>
  <div class="container">
    <h2 id="titulo">COLETA DE VALIDADE</h2>
    <label for="operador">Operador:</label>
    <select id="operador"><option value="">Carregando operadores...</option></select>

    <label for="codigo">Código do Produto:</label>
    <input type="number" id="codigo" placeholder="Digite ou escaneie o código" />

    <button onclick="iniciarLeitura()">Ler Código</button>

    <div id="video-container">
      <div id="reader"></div>
      <button id="close-camera-btn" onclick="fecharCamera()">Fechar Câmera</button>
    </div>

    <label for="validade">Data de Validade:</label>
    <input type="date" id="validade" required />

    <button onclick="enviarDados()">Enviar</button>
    <p id="mensagem"></p>
  </div>

  <script>
    document.getElementById("titulo").textContent = `COLETA DE VALIDADE - ${loja.toUpperCase()}`;

    let html5QrCode = null;

    window.onload = async () => {
      const select = document.getElementById("operador");
      try {
        const res = await fetch(`${scriptUrl}?action=getOperadores`);
        const operadores = await res.json();
        select.innerHTML = `<option value="">Selecione o operador</option>`;
        operadores.forEach(nome => {
          const opt = document.createElement("option");
          opt.value = nome;
          opt.textContent = nome;
          select.appendChild(opt);
        });

        const operadorSalvo = sessionStorage.getItem("operadorSelecionado");
        if (operadorSalvo) select.value = operadorSalvo;

        select.addEventListener("change", () => {
          sessionStorage.setItem("operadorSelecionado", select.value);
        });

      } catch (e) {
        select.innerHTML = `<option value="">Erro ao carregar</option>`;
      }
    };

    function iniciarLeitura() {
      document.getElementById("video-container").style.display = "flex";
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);
    }

    function onScanSuccess(decodedText) {
      document.getElementById("codigo").value = decodedText;
      fecharCamera();
    }

    function fecharCamera() {
      if (html5QrCode) html5QrCode.stop().then(() => html5QrCode.clear());
      document.getElementById("video-container").style.display = "none";
    }

    async function enviarDados() {
      const operador = document.getElementById("operador").value;
      const codigo = document.getElementById("codigo").value.trim();
      const validade = document.getElementById("validade").value;
      const msg = document.getElementById("mensagem");

      msg.textContent = "Enviando dados...";
      msg.style.color = "#0d283d";

      if (!operador || !codigo || !validade) {
        msg.textContent = "Preencha todos os campos.";
        msg.style.color = "#f44336";
        return;
      }

      const params = new URLSearchParams({ action: "salvarDados", operador, codigo, validade });

      try {
        const res = await fetch(`${scriptUrl}?${params.toString()}`);
        const data = await res.json();
        msg.textContent = data.mensagem;
        msg.style.color = data.status === "Sucesso" ? "#0d283d" : "#f44336";

        if (data.status === "Sucesso") {
          document.getElementById("codigo").value = "";
          document.getElementById("validade").value = "";
        }
      } catch {
        msg.textContent = "Erro ao enviar dados.";
        msg.style.color = "#f44336";
      }

      setTimeout(() => { msg.textContent = ""; }, 3000);
    }
  </script>
</body>
</html>
